{% extends 'base.html' %}

{% block content %}

<div class="container mt-4">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-1">Documentos</h2>
      <p class="text-muted mb-0">Control de documentos de toda la flota</p>
    </div>
  </div>

  <!-- Filtros y export -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="btn-group" role="group">
      <a href="{% url 'documento_list' %}"
         class="btn btn-outline-light {% if not estado %}active{% endif %}">
        Todos ({{ total_todos }})
      </a>
      <a href="{% url 'documento_list' %}?estado=proximos"
         class="btn btn-outline-warning {% if estado == 'proximos' %}active{% endif %}">
        Próximos ({{ total_proximos }})
      </a>
      <a href="{% url 'documento_list' %}?estado=vencidos"
         class="btn btn-outline-danger {% if estado == 'vencidos' %}active{% endif %}">
        Vencidos ({{ total_vencidos }})
      </a>
      <a href="{% url 'documento_list' %}?estado=vigentes"
         class="btn btn-outline-success {% if estado == 'vigentes' %}active{% endif %}">
        Vigentes ({{ total_vigentes }})
      </a>
    </div>

    <div>
      <a
        href="{% url 'documento_export_csv' %}{% if estado %}?estado={{ estado }}{% endif %}"
        class="btn btn-outline-light btn-sm"
      >
        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Exportar CSV
      </a>
    </div>
  </div>

  <!-- Tabla -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>Vehículo</th>
          <th>Tipo</th>
          <th>Fecha expedición</th>
          <th>Fecha vencimiento</th>
          <th>Estado</th>
          <th>Responsable</th>
          <th>Archivo</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for doc in documentos %}
          <tr>
            <!-- Vehículo -->
            <td>
              <a href="{% url 'vehiculo_detail' doc.vehiculo.pk %}" class="link-light text-decoration-underline">
                {{ doc.vehiculo.placa }}
              </a>
            </td>

            <!-- Tipo -->
            <td>{{ doc.tipo.nombre }}</td>

            <!-- Fechas -->
            <td>{{ doc.fecha_expedicion|default:"-" }}</td>
            <td>{{ doc.fecha_vencimiento }}</td>

            <!-- Estado -->
            <td>
              {% if doc.estado == 'vencido' %}
                <span class="badge text-bg-danger">Vencido</span>
              {% elif doc.estado == 'proximo' %}
                <span class="badge text-bg-warning text-dark">Próximo</span>
              {% else %}
                <span class="badge text-bg-success">Vigente</span>
              {% endif %}
            </td>

            <!-- Responsable -->
            <td>
              {% if doc.vehiculo.responsable_nombre %}
                {{ doc.vehiculo.responsable_nombre }}
                {% if doc.vehiculo.responsable_email %}
                  <br>
                  <small class="text-muted">
                    <a href="mailto:{{ doc.vehiculo.responsable_email }}" class="link-secondary">
                      {{ doc.vehiculo.responsable_email }}
                    </a>
                  </small>
                {% endif %}
              {% else %}
                <span class="text-muted">Sin responsable</span>
              {% endif %}
            </td>

            <!-- Archivo (Cloudinary PDF) -->
            <td>
              {% if doc.archivo %}
                <a href="{{ doc.archivo.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-file-earmark-pdf me-1"></i> Ver PDF
                </a>
              {% else %}
                <span class="text-muted">Sin archivo</span>
              {% endif %}
            </td>

            <!-- Acciones -->
            <td class="text-end">
              <a href="{% url 'documento_update' doc.pk %}" class="btn btn-sm btn-secondary mb-1">
                <i class="bi bi-pencil"></i>
              </a>
              <a href="{% url 'documento_delete' doc.pk %}" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash"></i>
              </a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">
              No hay documentos para mostrar.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% endblock %}
